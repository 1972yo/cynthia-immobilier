<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Test Complet - Syst√®me Cynthia</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f6fa;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border-left: 4px solid #007bff;
            background: #f8f9fa;
        }
        .test-result {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-weight: bold;
        }
        .btn:hover { background: #0056b3; }
        .btn-test { background: #28a745; }
        .btn-test:hover { background: #1e7e34; }
        #console-log {
            background: #000;
            color: #00ff00;
            padding: 20px;
            font-family: monospace;
            font-size: 12px;
            height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            border-radius: 5px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß™ Test Complet - Syst√®me Cynthia Bernier</h1>
        <p><strong>Lebel-sur-Qu√©villon, Nord-du-Qu√©bec</strong></p>
        
        <div class="test-section">
            <h3>üîß Tests des Composants</h3>
            <button class="btn btn-test" onclick="testComponents()">Test Composants</button>
            <button class="btn btn-test" onclick="testFeatures()">Test Fonctionnalit√©s ON/OFF</button>
            <button class="btn btn-test" onclick="testIdentity()">Test Protection Identit√©</button>
            <button class="btn btn-test" onclick="testIA()">Test IA OpenAI</button>
            
            <div id="component-results"></div>
        </div>
        
        <div class="test-section">
            <h3>üîó Test Int√©gration APIs</h3>
            <button class="btn btn-test" onclick="testAPIConnection()">Test Communication APIs</button>
            <button class="btn btn-test" onclick="testFormSubmission()">Test Soumission Formulaire</button>
            <button class="btn btn-test" onclick="testDashboardSync()">Test Sync Dashboard</button>
            
            <div id="integration-results"></div>
        </div>
        
        <div class="test-section">
            <h3>üì± Test Mobile/PWA</h3>
            <button class="btn btn-test" onclick="testPWA()">Test PWA</button>
            <button class="btn btn-test" onclick="testMobile()">Test Responsive</button>
            
            <div id="mobile-results"></div>
        </div>
        
        <div class="test-section">
            <h3>üö® Test Sc√©narios Complets</h3>
            <button class="btn btn-test" onclick="testFullWorkflow()">Workflow Complet</button>
            <button class="btn btn-test" onclick="testEmergencyMode()">Mode Urgence</button>
            
            <div id="scenario-results"></div>
        </div>
        
        <div class="test-section">
            <h3>üìä Actions</h3>
            <button class="btn" onclick="clearAllData()">üóëÔ∏è Vider Toutes Donn√©es</button>
            <button class="btn" onclick="showSystemStatus()">üìà √âtat Syst√®me</button>
            <button class="btn" onclick="exportTestReport()">üìÅ Export Rapport</button>
        </div>
        
        <div id="console-log"></div>
    </div>

    <!-- Scripts du syst√®me -->
    <script src="config/features-control.js"></script>
    <script src="services/identity-protection.js"></script>
    <script src="services/email-service.js"></script>
    <script src="assets/js/system-integration.js"></script>

    <script>
        // Console custom pour affichage
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        const consoleDiv = document.getElementById('console-log');
        
        function logToDiv(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString('fr-CA');
            const prefix = type === 'error' ? '‚ùå' : type === 'warn' ? '‚ö†Ô∏è' : '‚úÖ';
            consoleDiv.innerHTML += `[${timestamp}] ${prefix} ${message}\n`;
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }
        
        console.log = (...args) => {
            originalLog(...args);
            logToDiv(args.join(' '), 'log');
        };
        
        console.error = (...args) => {
            originalError(...args);
            logToDiv(args.join(' '), 'error');
        };
        
        console.warn = (...args) => {
            originalWarn(...args);
            logToDiv(args.join(' '), 'warn');
        };

        // Tests des composants
        async function testComponents() {
            console.log('üîß D√©but test composants...');
            const results = document.getElementById('component-results');
            results.innerHTML = '';
            
            try {
                // Test FeaturesControl
                if (window.FeaturesControl) {
                    results.innerHTML += '<div class="test-result success">‚úÖ FeaturesControl charg√©</div>';
                    console.log('FeaturesControl OK');
                } else {
                    results.innerHTML += '<div class="test-result error">‚ùå FeaturesControl manquant</div>';
                    console.error('FeaturesControl non trouv√©');
                }
                
                // Test IdentityProtection
                if (window.IdentityProtection) {
                    results.innerHTML += '<div class="test-result success">‚úÖ IdentityProtection charg√©</div>';
                    console.log('IdentityProtection OK');
                } else {
                    results.innerHTML += '<div class="test-result error">‚ùå IdentityProtection manquant</div>';
                    console.error('IdentityProtection non trouv√©');
                }
                
                // Test EmailService
                if (window.EmailService) {
                    const emailService = new window.EmailService();
                    results.innerHTML += '<div class="test-result success">‚úÖ EmailService instanci√©</div>';
                    console.log('EmailService OK');
                } else {
                    results.innerHTML += '<div class="test-result error">‚ùå EmailService manquant</div>';
                    console.error('EmailService non trouv√©');
                }
                
                // Test SystemIntegration
                if (window.SystemIntegration) {
                    results.innerHTML += '<div class="test-result success">‚úÖ SystemIntegration charg√©</div>';
                    console.log('SystemIntegration OK');
                } else {
                    results.innerHTML += '<div class="test-result error">‚ùå SystemIntegration manquant</div>';
                    console.error('SystemIntegration non trouv√©');
                }
                
            } catch (error) {
                results.innerHTML += `<div class="test-result error">‚ùå Erreur: ${error.message}</div>`;
                console.error('Erreur test composants:', error);
            }
        }
        
        async function testFeatures() {
            console.log('üîß Test fonctionnalit√©s ON/OFF...');
            const results = document.getElementById('component-results');
            
            if (window.FeaturesControl) {
                try {
                    const status = window.FeaturesControl.getStatus();
                    results.innerHTML += '<div class="test-result success">‚úÖ √âtat fonctionnalit√©s r√©cup√©r√©</div>';
                    console.log('√âtat features:', status);
                    
                    // Test toggle
                    window.FeaturesControl.toggle('ia_analysis');
                    results.innerHTML += '<div class="test-result success">‚úÖ Toggle IA test√©</div>';
                    console.log('Toggle IA OK');
                    
                } catch (error) {
                    results.innerHTML += `<div class="test-result error">‚ùå Erreur features: ${error.message}</div>`;
                    console.error('Erreur test features:', error);
                }
            }
        }
        
        async function testIdentity() {
            console.log('üõ°Ô∏è Test protection identit√©...');
            const results = document.getElementById('component-results');
            
            if (window.IdentityProtection) {
                try {
                    // Test validation normale
                    const validData = { adresse: '123 Main St, Lebel-sur-Qu√©villon' };
                    const valid = window.IdentityProtection.validate(validData);
                    
                    if (valid) {
                        results.innerHTML += '<div class="test-result success">‚úÖ Validation identit√© OK</div>';
                        console.log('Validation normale OK');
                    }
                    
                    // Test protection (doit bloquer)
                    const testResult = window.IdentityProtection.testProtection();
                    if (testResult) {
                        results.innerHTML += '<div class="test-result success">‚úÖ Protection contre faux Cynthia OK</div>';
                        console.log('Protection anti-confusion OK');
                    }
                    
                } catch (error) {
                    results.innerHTML += `<div class="test-result error">‚ùå Erreur identit√©: ${error.message}</div>`;
                    console.error('Erreur test identit√©:', error);
                }
            }
        }
        
        async function testIA() {
            console.log('ü§ñ Test connexion IA...');
            const results = document.getElementById('component-results');
            
            if (window.EmailService) {
                try {
                    const emailService = new window.EmailService();
                    const connected = await emailService.testConnection();
                    
                    if (connected) {
                        results.innerHTML += '<div class="test-result success">‚úÖ Connexion OpenAI OK</div>';
                        console.log('OpenAI connect√©');
                    } else {
                        results.innerHTML += '<div class="test-result warning">‚ö†Ô∏è Connexion OpenAI limit√©e (normal en test)</div>';
                        console.warn('OpenAI test limit√©');
                    }
                    
                } catch (error) {
                    results.innerHTML += '<div class="test-result warning">‚ö†Ô∏è Test IA limit√© (normal)</div>';
                    console.warn('Test IA:', error.message);
                }
            }
        }
        
        async function testAPIConnection() {
            console.log('üîó Test communication APIs...');
            const results = document.getElementById('integration-results');
            results.innerHTML = '';
            
            if (window.SystemIntegration) {
                try {
                    const status = window.SystemIntegration.getSystemStatus();
                    results.innerHTML += '<div class="test-result success">‚úÖ Statut syst√®me r√©cup√©r√©</div>';
                    console.log('Status syst√®me:', status);
                    
                    const testOK = window.SystemIntegration.testConnection();
                    if (testOK) {
                        results.innerHTML += '<div class="test-result success">‚úÖ Test connexion APIs OK</div>';
                        console.log('Communication inter-API OK');
                    }
                    
                } catch (error) {
                    results.innerHTML += `<div class="test-result error">‚ùå Erreur APIs: ${error.message}</div>`;
                    console.error('Erreur test APIs:', error);
                }
            }
        }
        
        async function testFormSubmission() {
            console.log('üìù Test soumission formulaire...');
            const results = document.getElementById('integration-results');
            
            try {
                const testData = {
                    adresse: '123 Test Street, Lebel-sur-Qu√©villon',
                    prop1Nom: 'Client Test',
                    prop1Tel1: '418-555-1234',
                    anneeConstruction: '2010',
                    notesSpeciales: 'Test automatis√© du syst√®me'
                };
                
                if (window.EmailService) {
                    const emailService = new window.EmailService();
                    const result = await emailService.sendFormToCynthia(testData);
                    
                    if (result.success) {
                        results.innerHTML += '<div class="test-result success">‚úÖ Soumission formulaire + IA OK</div>';
                        console.log('Test soumission r√©ussi:', result);
                    } else {
                        results.innerHTML += '<div class="test-result warning">‚ö†Ô∏è Soumission en mode fallback</div>';
                        console.warn('Soumission fallback:', result);
                    }
                }
                
            } catch (error) {
                results.innerHTML += `<div class="test-result error">‚ùå Erreur soumission: ${error.message}</div>`;
                console.error('Erreur test soumission:', error);
            }
        }
        
        async function testDashboardSync() {
            console.log('üì° Test synchronisation dashboard...');
            const results = document.getElementById('integration-results');
            
            try {
                // V√©rifier les notifications stock√©es
                const notifications = localStorage.getItem('cynthia_notifications');
                if (notifications) {
                    const count = JSON.parse(notifications).length;
                    results.innerHTML += `<div class="test-result success">‚úÖ Dashboard sync: ${count} notifications</div>`;
                    console.log(`${count} notifications en attente pour dashboard`);
                } else {
                    results.innerHTML += '<div class="test-result warning">‚ö†Ô∏è Pas de notifications dashboard</div>';
                    console.warn('Aucune notification dashboard trouv√©e');
                }
                
            } catch (error) {
                results.innerHTML += `<div class="test-result error">‚ùå Erreur sync: ${error.message}</div>`;
                console.error('Erreur test sync:', error);
            }
        }
        
        async function testPWA() {
            console.log('üì± Test PWA...');
            const results = document.getElementById('mobile-results');
            results.innerHTML = '';
            
            try {
                // Test service worker
                if ('serviceWorker' in navigator) {
                    results.innerHTML += '<div class="test-result success">‚úÖ Service Worker support√©</div>';
                    console.log('Service Worker disponible');
                } else {
                    results.innerHTML += '<div class="test-result error">‚ùå Service Worker non support√©</div>';
                }
                
                // Test manifest
                if (window.location.pathname.includes('admin')) {
                    results.innerHTML += '<div class="test-result success">‚úÖ PWA Dashboard d√©tect√©</div>';
                    console.log('Contexte PWA dashboard');
                } else {
                    results.innerHTML += '<div class="test-result success">‚úÖ Formulaire public d√©tect√©</div>';
                    console.log('Contexte formulaire public');
                }
                
            } catch (error) {
                results.innerHTML += `<div class="test-result error">‚ùå Erreur PWA: ${error.message}</div>`;
                console.error('Erreur test PWA:', error);
            }
        }
        
        async function testMobile() {
            console.log('üì± Test responsive...');
            const results = document.getElementById('mobile-results');
            
            const isMobile = window.innerWidth <= 768;
            const viewport = `${window.innerWidth}x${window.innerHeight}`;
            
            results.innerHTML += `<div class="test-result success">‚úÖ Viewport: ${viewport}</div>`;
            results.innerHTML += `<div class="test-result ${isMobile ? 'success' : 'warning'}">üì± Mode: ${isMobile ? 'Mobile' : 'Desktop'}</div>`;
            
            console.log(`Viewport: ${viewport}, Mobile: ${isMobile}`);
        }
        
        async function testFullWorkflow() {
            console.log('üéØ Test workflow complet...');
            const results = document.getElementById('scenario-results');
            results.innerHTML = '';
            
            try {
                results.innerHTML += '<div class="test-result success">‚úÖ D√©but workflow complet</div>';
                
                // 1. Validation identit√©
                const validData = { adresse: 'Test Lebel-sur-Qu√©villon' };
                const identityOK = window.IdentityProtection.validate(validData);
                results.innerHTML += `<div class="test-result ${identityOK ? 'success' : 'error'}">1. Validation identit√©: ${identityOK ? 'OK' : '√âCHOU√â'}</div>`;
                
                // 2. Features check
                const features = window.FeaturesControl ? window.FeaturesControl.getStatus() : null;
                results.innerHTML += `<div class="test-result ${features ? 'success' : 'error'}">2. √âtat features: ${features ? 'OK' : '√âCHOU√â'}</div>`;
                
                // 3. Simulation envoi
                if (identityOK && features) {
                    results.innerHTML += '<div class="test-result success">3. Workflow: PR√äT POUR PRODUCTION</div>';
                    console.log('‚úÖ WORKFLOW COMPLET VALID√â');
                } else {
                    results.innerHTML += '<div class="test-result error">3. Workflow: CORRECTIONS REQUISES</div>';
                    console.error('‚ùå Workflow incomplet');
                }
                
            } catch (error) {
                results.innerHTML += `<div class="test-result error">‚ùå Erreur workflow: ${error.message}</div>`;
                console.error('Erreur workflow:', error);
            }
        }
        
        async function testEmergencyMode() {
            console.log('üö® Test mode urgence...');
            const results = document.getElementById('scenario-results');
            
            try {
                if (window.FeaturesControl) {
                    window.FeaturesControl.emergencyShutdown();
                    results.innerHTML += '<div class="test-result success">‚úÖ Mode urgence activ√©</div>';
                    console.log('Mode urgence test√©');
                    
                    // Restaurer apr√®s test
                    setTimeout(() => {
                        window.FeaturesControl.restoreFromEmergency();
                        console.log('Mode normal restaur√©');
                    }, 2000);
                }
                
            } catch (error) {
                results.innerHTML += `<div class="test-result error">‚ùå Erreur urgence: ${error.message}</div>`;
                console.error('Erreur test urgence:', error);
            }
        }
        
        function clearAllData() {
            if (confirm('Vider toutes les donn√©es de test?')) {
                localStorage.clear();
                console.log('üóëÔ∏è Toutes donn√©es effac√©es');
                location.reload();
            }
        }
        
        function showSystemStatus() {
            console.log('üìà √âtat syst√®me complet:');
            
            const status = {
                features: window.FeaturesControl ? window.FeaturesControl.getStatus() : null,
                identity: window.IdentityProtection ? window.IdentityProtection.getProtectionStatus() : null,
                integration: window.SystemIntegration ? window.SystemIntegration.getSystemStatus() : null,
                localStorage: {
                    notifications: localStorage.getItem('cynthia_notifications') ? JSON.parse(localStorage.getItem('cynthia_notifications')).length : 0,
                    formData: !!localStorage.getItem('cynthia_form_data'),
                    incidents: localStorage.getItem('identity_incidents') ? JSON.parse(localStorage.getItem('identity_incidents')).length : 0
                }
            };
            
            console.log(JSON.stringify(status, null, 2));
        }
        
        function exportTestReport() {
            const report = {
                timestamp: new Date().toISOString(),
                system: 'CYNTHIA_ASSISTANT',
                version: '1.0.0',
                location: 'Lebel-sur-Qu√©villon, Nord-du-Qu√©bec',
                tests_completed: true,
                system_status: showSystemStatus()
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cynthia-system-test-${Date.now()}.json`;
            a.click();
            
            console.log('üìÅ Rapport export√©');
        }
        
        // Test automatique au chargement
        setTimeout(() => {
            console.log('üéØ SYST√àME CYNTHIA BERNIER - TESTS AUTOMATIQUES');
            console.log('üìç Lebel-sur-Qu√©villon, Nord-du-Qu√©bec');
            console.log('‚è∞ ' + new Date().toLocaleString('fr-CA'));
            console.log('=====================================');
            
            testComponents();
        }, 1000);
    </script>
</body>
</html>