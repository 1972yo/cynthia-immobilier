// üì± DASHBOARD CYNTHIA - Gestion intelligente avec ON/OFF
// Interface simple pour contr√¥ler toutes les fonctionnalit√©s

class CynthiaDashboard {
    constructor() {
        this.currentSection = 'overview';
        this.featuresControl = window.FeaturesControl;
        this.properties = [];
        this.contacts = [];
        
        this.init();
    }
    
    async init() {
        console.log('üì± Initialisation Dashboard Cynthia...');
        
        // Protection identit√©
        if (!this.validateAccess()) return;
        
        // Charger donn√©es
        await this.loadData();
        
        // Initialiser interface
        this.initializeInterface();
        
        // Mettre √† jour affichage
        this.updateDisplay();
        
        console.log('‚úÖ Dashboard pr√™t !');
    }
    
    validateAccess() {
        // Protection simple - v√©rifier que c'est bien Cynthia
        const userConfirmed = sessionStorage.getItem('cynthia_dashboard_access');
        const permanentSession = localStorage.getItem('cynthia_admin_permanent');
        
        // Si session permanente existe, pas besoin de re-v√©rifier
        if (permanentSession === 'true') {
            sessionStorage.setItem('cynthia_dashboard_access', 'true');
            console.log('üîì Session permanente d√©tect√©e - Acc√®s automatique accord√©');
            return true;
        }
        
        if (!userConfirmed) {
            const isAuthentic = confirm(`
üîê ACC√àS DASHBOARD

Confirmez-vous √™tre Cynthia Bernier de Lebel-sur-Qu√©villon ?

Cette v√©rification prot√®ge vos donn√©es confidentielles.
            `);
            
            if (!isAuthentic) {
                alert('‚ùå Acc√®s refus√©. Restez sur la page d\'accueil.');
                // Mode admin : ne pas rediriger, rester sur place
                return false;
            }
            
            // Session permanente pour Cynthia (pas besoin de re-login)
            sessionStorage.setItem('cynthia_dashboard_access', 'true');
            localStorage.setItem('cynthia_admin_permanent', 'true');
            
            console.log('üîí Session admin permanente activ√©e pour Cynthia');
        }
        
        return true;
    }
    
    async loadData() {
        try {
            // Charger propri√©t√©s sauvegard√©es
            const savedProperties = localStorage.getItem('cynthia_properties');
            this.properties = savedProperties ? JSON.parse(savedProperties) : [];
            
            // Charger contacts
            const savedContacts = localStorage.getItem('cynthia_contacts');
            this.contacts = savedContacts ? JSON.parse(savedContacts) : [];
            
            console.log(`üìä Donn√©es charg√©es: ${this.properties.length} propri√©t√©s, ${this.contacts.length} contacts`);
        } catch (error) {
            console.error('‚ùå Erreur chargement donn√©es:', error);
        }
    }
    
    initializeInterface() {
        // Synchroniser √©tat des toggles avec configuration
        const config = this.featuresControl.getStatus();
        
        // API #1 toggles
        this.updateToggle('ia_analysis', config.api1_status.ia_analysis);
        this.updateToggle('auto_email', config.api1_status.auto_email);
        this.updateToggle('photo_optimization', config.api1_status.photo_optimization);
        
        // API #2 toggles  
        this.updateToggle('public_website', config.api2_status.public_website);
        this.updateToggle('auto_advertising', config.api2_status.auto_advertising);
        this.updateToggle('analytics_tracking', config.api2_status.analytics_tracking);
        
        // Afficher section par d√©faut
        this.showSection('overview');
    }
    
    updateToggle(featureId, enabled) {
        const toggle = document.getElementById(featureId);
        if (toggle) {
            toggle.checked = enabled;
        }
    }
    
    updateDisplay() {
        // Mettre √† jour statistiques
        document.getElementById('totalProperties').textContent = this.properties.length;
        document.getElementById('totalContacts').textContent = this.contacts.length;
        
        // Compter fonctionnalit√©s actives
        const config = this.featuresControl.getStatus();
        const activeCount = Object.values({...config.api1_status, ...config.api2_status})
            .filter(Boolean).length;
        document.getElementById('activeFeatures').textContent = activeCount;
        
        // Mettre √† jour vue d'ensemble fonctionnalit√©s
        this.updateFeaturesOverview();
    }
    
    updateFeaturesOverview() {
        const container = document.getElementById('featuresOverview');
        const config = this.featuresControl.getStatus();
        
        const features = [
            { key: 'ia_analysis', label: 'ü§ñ IA', status: config.api1_status.ia_analysis },
            { key: 'auto_email', label: 'üìß Emails', status: config.api1_status.auto_email },
            { key: 'photo_optimization', label: 'üì∑ Photos', status: config.api1_status.photo_optimization },
            { key: 'public_website', label: 'üåê Site', status: config.api2_status.public_website },
            { key: 'auto_advertising', label: 'üì± Pubs', status: config.api2_status.auto_advertising },
            { key: 'analytics_tracking', label: 'üìä Stats', status: config.api2_status.analytics_tracking }
        ];
        
        container.innerHTML = features.map(feature => `
            <span class="feature-status ${feature.status ? 'active' : 'inactive'}">
                ${feature.label} ${feature.status ? '‚úÖ' : '‚≠ï'}
            </span>
        `).join('');
    }
    
    // Navigation entre sections
    showSection(sectionName) {
        // Cacher toutes sections
        document.querySelectorAll('.dashboard-section').forEach(section => {
            section.classList.remove('active');
        });
        
        // D√©sactiver tous boutons nav
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Afficher section demand√©e
        const targetSection = document.getElementById(`${sectionName}Section`);
        const targetBtn = document.getElementById(`${sectionName}Btn`);
        
        if (targetSection) targetSection.classList.add('active');
        if (targetBtn) targetBtn.classList.add('active');
        
        this.currentSection = sectionName;
        
        // Actions sp√©cifiques par section
        if (sectionName === 'properties') {
            this.loadPropertiesSection();
        } else if (sectionName === 'contacts') {
            this.loadContactsSection();
        }
    }
    
    // Toggle fonctionnalit√©
    toggleFeature(featureName) {
        const wasEnabled = this.featuresControl.isEnabled(featureName);
        const success = this.featuresControl.toggle(featureName);
        
        if (success) {
            const isNowEnabled = this.featuresControl.isEnabled(featureName);
            
            // Feedback visuel
            this.showFeatureToggleToast(featureName, isNowEnabled);
            
            // Mettre √† jour affichage
            this.updateDisplay();
            
            // Actions sp√©cifiques selon fonctionnalit√©
            this.handleFeatureToggle(featureName, isNowEnabled);
        }
    }
    
    showFeatureToggleToast(featureName, enabled) {
        const messages = {
            'ia_analysis': enabled ? 'ü§ñ IA activ√©e ! Vos fiches seront analys√©es automatiquement.' : 'ü§ñ IA d√©sactiv√©e. Mode manuel actif.',
            'auto_email': enabled ? 'üìß Emails automatiques activ√©s !' : 'üìß Emails automatiques d√©sactiv√©s.',
            'photo_optimization': enabled ? 'üì∑ Optimisation photos activ√©e !' : 'üì∑ Optimisation photos d√©sactiv√©e.',
            'public_website': enabled ? 'üåê Site web public activ√© ! Visible par tous.' : 'üåê Site web d√©sactiv√©. Mode priv√©.',
            'auto_advertising': enabled ? 'üì± Publicit√©s automatiques activ√©es !' : 'üì± Publicit√©s d√©sactiv√©es.',
            'analytics_tracking': enabled ? 'üìä Analytics activ√©s !' : 'üìä Analytics d√©sactiv√©s.'
        };
        
        const message = messages[featureName] || `${featureName} ${enabled ? 'activ√©' : 'd√©sactiv√©'}`;
        
        // Toast simple
        this.showToast(message, enabled ? 'success' : 'info');
    }
    
    handleFeatureToggle(featureName, enabled) {
        // Actions sp√©cifiques selon fonctionnalit√© activ√©e/d√©sactiv√©e
        switch(featureName) {
            case 'public_website':
                // Notifier API #2 du changement
                this.notifyAPI2StatusChange('website', enabled);
                break;
                
            case 'auto_advertising':
                if (enabled) {
                    this.showToast('‚ö†Ô∏è Publicit√©s automatiques n√©cessitent configuration Facebook/Google Ads', 'warning');
                }
                break;
                
            case 'ia_analysis':
                if (enabled) {
                    this.showToast('ü§ñ Prochaines fiches seront analys√©es par IA', 'info');
                }
                break;
        }
    }
    
    // Mode urgence
    emergencyMode() {
        const confirm = window.confirm(`
üö® MODE URGENCE

Ceci va IMM√âDIATEMENT d√©sactiver toutes les fonctionnalit√©s automatiques :
‚Ä¢ Site web public
‚Ä¢ Publicit√©s 
‚Ä¢ IA
‚Ä¢ Emails automatiques

Seules les fonctions de base resteront actives.

ACTIVER MODE URGENCE ?
        `);
        
        if (confirm) {
            this.featuresControl.emergencyMode();
            this.initializeInterface(); // Re-sync toggles
            this.updateDisplay();
            
            this.showToast('üö® MODE URGENCE ACTIV√â - Toutes automations d√©sactiv√©es', 'warning');
        }
    }
    
    // Reset configuration
    resetToDefault() {
        if (this.featuresControl.resetToDefault()) {
            this.initializeInterface(); // Re-sync toggles
            this.updateDisplay();
            
            this.showToast('üîÑ Configuration remise par d√©faut', 'info');
        }
    }
    
    // Notifications simples
    showToast(message, type = 'info') {
        // Toast simple sans librairie externe
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${type === 'success' ? '#28a745' : type === 'warning' ? '#fd7e14' : '#007bff'};
            color: white;
            padding: 12px 16px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            font-size: 14px;
            max-width: 300px;
        `;
        
        document.body.appendChild(toast);
        
        // Animation entr√©e
        setTimeout(() => toast.style.transform = 'translateX(0)', 100);
        
        // Suppression automatique
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => document.body.removeChild(toast), 300);
        }, 3000);
    }
    
    // Placeholder fonctions (√† d√©velopper)
    loadPropertiesSection() {
        console.log('üìä Chargement section propri√©t√©s...');
        // TODO: Afficher liste propri√©t√©s
    }
    
    loadContactsSection() {
        console.log('üë• Chargement section contacts...');
        // TODO: Afficher liste contacts
    }
    
    createNewProperty() {
        this.showToast('üè† Fonction cr√©ation fiche en d√©veloppement', 'info');
        // TODO: Ouvrir interface cr√©ation propri√©t√©
    }
    
    viewContacts() {
        this.showSection('contacts');
    }
    
    // Communication avec API #2
    notifyAPI2StatusChange(component, enabled) {
        try {
            // Notifier API #2 du changement d'√©tat
            const event = new CustomEvent('api2-status-change', {
                detail: { component, enabled, timestamp: new Date() }
            });
            window.dispatchEvent(event);
            
            console.log(`üì° API #2 notifi√©e: ${component} = ${enabled}`);
        } catch (error) {
            console.error('‚ùå Erreur notification API #2:', error);
        }
    }
}

// Fonctions globales pour les boutons
window.showSection = (section) => window.cynthiaDashboard.showSection(section);
window.toggleFeature = (feature) => window.cynthiaDashboard.toggleFeature(feature);
window.emergencyMode = () => window.cynthiaDashboard.emergencyMode();
window.resetToDefault = () => window.cynthiaDashboard.resetToDefault();
window.createNewProperty = () => window.cynthiaDashboard.createNewProperty();
window.viewContacts = () => window.cynthiaDashboard.viewContacts();

window.toggleEmergencyMode = () => {
    // Toggle bouton urgence visuel
    const btn = document.getElementById('emergencyBtn');
    if (btn.textContent.includes('Urgence')) {
        window.cynthiaDashboard.emergencyMode();
    }
};

// Initialisation
document.addEventListener('DOMContentLoaded', () => {
    window.cynthiaDashboard = new CynthiaDashboard();
});

// Service Worker pour PWA
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
            .then(registration => console.log('üì± PWA Service Worker registered'))
            .catch(error => console.log('‚ùå SW registration failed:', error));
    });
}